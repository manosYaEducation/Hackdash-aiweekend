<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalle del Proyecto</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/project.css">
</head>
<body>
  <!-- Project Header -->
  <div class="project-header">
    <div class="header-content">
      <div class="project-info">
        <button class="back-button" onclick="goBack()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
          </svg>
          Volver al Dashboard
        </button>
        <div class="project-title-section">
          <div class="dot blue"></div>
          <div>
            <h1 class="project-title" id="projectTitle">Cargando...</h1>
            <p class="project-subtitle" id="projectDescription">Cargando descripción...</p>
          </div>
        </div>
      </div>
      <div class="project-actions">
        <span class="status-badge status-active" id="projectStatus">Activo</span>
        <button class="menu-button" onclick="toggleProjectMenu()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm6 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm-6 5.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm6 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div class="project-container">
    <!-- Statistics -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Progreso</h3>
        <div class="stat-value" id="progressValue">65%</div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 65%"></div>
        </div>
        <div class="stat-icon stat-icon-blue">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
          </svg>
        </div>
      </div>
      <div class="stat-card">
        <h3>Tareas</h3>
        <div class="stat-value" id="tasksValue">1/3</div>
        <div class="stat-icon stat-icon-green">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
      </div>
      <div class="stat-card">
        <h3>Miembros</h3>
        <div class="stat-value" id="membersValue">4</div>
        <div class="stat-icon stat-icon-purple">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
          </svg>
        </div>
      </div>
      <div class="stat-card">
        <h3>Archivos</h3>
        <div class="stat-value" id="filesValue">3</div>
        <div class="stat-icon stat-icon-yellow">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
          </svg>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" onclick="showTab('tasks')">Tareas</div>
      <div class="tab" onclick="showTab('files')">Archivos</div>
      <div class="tab" onclick="showTab('members')">Miembros</div>
      <div class="tab" onclick="showTab('activity')">Actividad</div>
    </div>

    <!-- Tasks Tab -->
    <div id="tasks-tab" class="tab-content active">
      <div class="section-header">
        <h2 class="section-title">Tareas del Proyecto</h2>
        <button class="btn btn-primary" onclick="showCreateTaskModal()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
          Nueva Tarea
        </button>
      </div>
      <div id="tasksList">
        <!-- Tasks will be loaded here -->
      </div>
    </div>

    <!-- Files Tab -->
    <div id="files-tab" class="tab-content">
      <div class="section-header">
        <h2 class="section-title">Archivos del Proyecto</h2>
        <button class="btn btn-primary" onclick="showUploadFileModal()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
          Subir Archivo
        </button>
      </div>
      <div id="filesList">
        <!-- Files will be loaded here -->
      </div>
    </div>

    <!-- Members Tab -->
    <div id="members-tab" class="tab-content">
      <div class="section-header">
        <h2 class="section-title">Miembros del Proyecto</h2>
        <button class="btn btn-primary" onclick="showInviteMemberModal()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
          Invitar Miembro
        </button>
      </div>
      <div id="membersList">
        <!-- Members will be loaded here -->
      </div>
    </div>

    <!-- Activity Tab -->
    <div id="activity-tab" class="tab-content">
      <div class="section-header">
        <h2 class="section-title">Actividad del Proyecto</h2>
      </div>
      <div id="activityList">
        <!-- Activity will be loaded here -->
      </div>
    </div>
  </div>

  <script src="./js/verifylogin.js"></script>
  <script>
    let currentProjectId = null;

    // Verificar autenticación al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar si el usuario está logueado usando el sistema existente
      const userLoggedIn = sessionStorage.getItem('userLoggedIn');
      const estaLogueadoLocal = localStorage.getItem('userLoggedIn');
      const token = sessionStorage.getItem('token') || localStorage.getItem('token');
      const userId = localStorage.getItem('user_id') || localStorage.getItem('userId');
      const username = localStorage.getItem('username') || localStorage.getItem('userName') || obtenerUsuario();
      
      console.log('Verificando autenticación:', {
        userLoggedIn,
        estaLogueadoLocal,
        token,
        userId,
        username
      });
      
      // Verificar múltiples condiciones de autenticación
      if ((!userLoggedIn && !estaLogueadoLocal) || !token || !userId || !username) {
        console.log('Usuario no autenticado, redirigiendo al login');
        // Limpiar cualquier dato residual
        sessionStorage.clear();
        localStorage.removeItem('userLoggedIn');
        localStorage.removeItem('user_id');
        localStorage.removeItem('userId');
        localStorage.removeItem('username');
        localStorage.removeItem('userName');
        localStorage.removeItem('token');
        
        // Redirigir al login
        window.location.href = 'login.html';
        return;
      }

      console.log('Usuario autenticado correctamente');

      // Obtener el ID del proyecto de la URL
      const urlParams = new URLSearchParams(window.location.search);
      currentProjectId = urlParams.get('id');
      
      if (currentProjectId) {
        loadProjectDetails();
      } else {
        alert('ID de proyecto no encontrado');
        goBack();
      }
    });

    function goBack() {
      const urlParams = new URLSearchParams(window.location.search);
      const dashboardSlug = urlParams.get('dashboard');
      if (dashboardSlug) {
        window.location.href = `dashboard.html?slug=${dashboardSlug}`;
      } else {
        window.location.href = 'blank.html';
      }
    }

    function showTab(tabName) {
      // Ocultar todas las pestañas
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Mostrar la pestaña seleccionada
      document.getElementById(`${tabName}-tab`).classList.add('active');
      document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
    }

    function loadProjectDetails() {
      // Cargar detalles del proyecto
      fetch(`../api/get_project.php?id=${currentProjectId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById('projectTitle').textContent = data.project.title;
            document.getElementById('projectDescription').textContent = data.project.description;
            
            // Actualizar estadísticas
            updateProjectStats();
            
            // Cargar contenido de las pestañas
            loadTasks();
            loadFiles();
            loadMembers();
            loadActivity();
          } else {
            alert('Error al cargar el proyecto');
            goBack();
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al cargar el proyecto');
          goBack();
        });
    }

    function updateProjectStats() {
      // Actualizar estadísticas del proyecto
      fetch(`../api/get_project_stats.php?id=${currentProjectId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById('progressValue').textContent = `${data.stats.progress}%`;
            document.querySelector('.progress-fill').style.width = `${data.stats.progress}%`;
            document.getElementById('tasksValue').textContent = `${data.stats.completed_tasks}/${data.stats.total_tasks}`;
            document.getElementById('membersValue').textContent = data.stats.total_members;
            document.getElementById('filesValue').textContent = data.stats.total_files;
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }

    function loadTasks() {
      fetch(`../api/get_project_tasks.php?id=${currentProjectId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const tasksList = document.getElementById('tasksList');
            tasksList.innerHTML = '';
            
            data.tasks.forEach(task => {
              const taskCard = createTaskCard(task);
              tasksList.appendChild(taskCard);
            });
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }

    function createTaskCard(task) {
      const taskCard = document.createElement('div');
      taskCard.className = 'task-card';
      
      const priorityClass = `priority-${task.priority}`;
      const priorityText = task.priority === 'high' ? 'Alta' : task.priority === 'medium' ? 'Media' : 'Baja';
      
      // Determinar si la tarea está completada basándose en el status
      const isCompleted = task.status === 'completed';
      const statusIcon = isCompleted ? 
        '<div class="task-status completed"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg></div>' : 
        '<div class="task-status pending"></div>';
      
      taskCard.innerHTML = `
        <div class="task-header">
          <div class="task-main-content">
            ${statusIcon}
            <div class="task-content">
              <div class="task-title-section">
                <div class="task-title">${task.title}</div>
                <span class="priority-badge ${priorityClass}">${priorityText}</span>
              </div>
              <div class="task-description">${task.description}</div>
            </div>
          </div>
                     <button class="task-menu-btn">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
               <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" />
               <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
             </svg>
           </button>
        </div>
        <div class="task-meta">
          <div class="task-assigned">
            <div class="member-avatar">${task.assigned_to ? task.assigned_to.split(' ').map(n => n[0]).join('') : '?'}</div>
            ${task.assigned_to || 'Sin asignar'}
          </div>
          <div class="task-due">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
            </svg>
            Vence: ${new Date(task.due_date).toLocaleDateString('es-ES')}
          </div>
        </div>
      `;
      
      return taskCard;
    }

    function loadFiles() {
      fetch(`../api/get_project_files.php?id=${currentProjectId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const filesList = document.getElementById('filesList');
            filesList.innerHTML = '';
            
            data.files.forEach(file => {
              const fileCard = createFileCard(file);
              filesList.appendChild(fileCard);
            });
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }

    function createFileCard(file) {
      const fileCard = document.createElement('div');
      fileCard.className = 'file-card';
      
      fileCard.innerHTML = `
        <div class="file-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
          </svg>
        </div>
        <div class="file-info">
          <h4>${file.original_name}</h4>
          <p>Subido por ${file.uploaded_by} • ${formatFileSize(file.file_size)}</p>
        </div>
      `;
      
      return fileCard;
    }

    function loadMembers() {
      fetch(`../api/get_project_members.php?id=${currentProjectId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';
            
            data.members.forEach(member => {
              const memberCard = createMemberCard(member);
              membersList.appendChild(memberCard);
            });
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }

    function createMemberCard(member) {
      const memberCard = document.createElement('div');
      memberCard.className = 'member-card';
      
      const roleClass = `role-${member.role}`;
      const roleText = member.role === 'owner' ? 'Propietario' : member.role === 'admin' ? 'Administrador' : 'Miembro';
      
      memberCard.innerHTML = `
        <div class="member-avatar-large">${member.avatar_initials}</div>
        <div class="member-info">
          <h4>${member.user_name}</h4>
          <p>${member.email}</p>
        </div>
        <span class="member-role ${roleClass}">${roleText}</span>
      `;
      
      return memberCard;
    }

    function loadActivity() {
      fetch(`../api/get_project_activity.php?id=${currentProjectId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const activityList = document.getElementById('activityList');
            activityList.innerHTML = '';
            
            data.activity.forEach(item => {
              const activityItem = createActivityItem(item);
              activityList.appendChild(activityItem);
            });
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }

    function createActivityItem(item) {
      const activityItem = document.createElement('div');
      activityItem.className = 'activity-item';
      
      const timeAgo = getTimeAgo(new Date(item.created_at));
      
      activityItem.innerHTML = `
        <div class="activity-header">
          <span class="activity-user">${item.user_name}</span>
          <span class="activity-action">${item.action}</span>
          <span class="activity-time">${timeAgo}</span>
        </div>
        <div class="activity-description">${item.description}</div>
      `;
      
      return activityItem;
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function getTimeAgo(date) {
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);
      
      if (diffInSeconds < 60) return 'Hace un momento';
      if (diffInSeconds < 3600) return `Hace ${Math.floor(diffInSeconds / 60)} minutos`;
      if (diffInSeconds < 86400) return `Hace ${Math.floor(diffInSeconds / 3600)} horas`;
      return `Hace ${Math.floor(diffInSeconds / 86400)} días`;
    }

    function showCreateTaskModal() {
      alert('Función de crear tarea próximamente disponible');
    }

    function showUploadFileModal() {
      alert('Función de subir archivo próximamente disponible');
    }

    function showInviteMemberModal() {
      alert('Función de invitar miembro próximamente disponible');
    }

    function toggleProjectMenu() {
      alert('Menú del proyecto próximamente disponible');
    }
  </script>
</body>
</html> 